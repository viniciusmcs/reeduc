{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Editar Cadastro</title>
    <link rel="stylesheet" href="{% static 'core/home.css' %}" />
    <link rel="stylesheet" href="{% static 'core/cadastro.css' %}" />
    <style>
        .edit-form-container {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .foto-section {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .foto-section h3 {
            margin: 0;
            font-size: 14px;
            font-weight: 600;
        }

        .foto-preview {
            width: 100%;
            aspect-ratio: 1;
            background: #f0f0f0;
            border: 2px dashed var(--border);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .foto-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .foto-upload-input {
            display: none;
        }

        .foto-upload-btn {
            padding: 10px 16px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: background 0.2s;
        }

        .foto-upload-btn:hover {
            background: var(--primary-dark, #0056b3);
        }

        .identificacao-section {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .identificacao-section h3 {
            margin: 0;
            font-size: 14px;
            font-weight: 600;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .form-group label {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 13px;
            font-family: inherit;
        }

        .form-group textarea {
            min-height: 60px;
            resize: vertical;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.1);
        }

        .form-errors {
            background: #fee;
            border: 1px solid #fcc;
            border-radius: 6px;
            padding: 12px;
            color: #c00;
            font-size: 13px;
            margin-bottom: 16px;
        }

        .form-section {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .form-actions {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .primary-button,
        .ghost-button {
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
        }

        .primary-button {
            background: var(--primary);
            color: white;
        }

        .primary-button:hover {
            background: var(--primary-dark, #0056b3);
        }

        .ghost-button {
            background: transparent;
            color: var(--primary);
            border: 1px solid var(--primary);
        }

        .ghost-button:hover {
            background: rgba(25, 118, 210, 0.05);
        }

        .form-full-width {
            grid-column: 1 / -1;
        }

        .field-error {
            color: #c00;
            font-size: 12px;
            margin-top: 4px;
        }
    </style>
</head>
<body>
    <div class="layout">
        <aside class="sidebar">
            <a class="brand" href="/home/">REEDUC</a>
            <button class="new-button" id="novoButton">
                <span class="icon">+</span>
                <span>Novo</span>
            </button>
            <div class="new-menu" id="novoMenu">
                <a href="/home/cadastro/adicionar">Cadastro</a>
                <a href="/atendimentos/adicionar">Atendimento</a>
                <a href="/agendamentos/adicionar">Agendamento</a>
            </div>
            <nav class="menu">
                <div class="menu-group">
                    <button class="menu__item menu__item--toggle" type="button" data-target="cadastros-submenu">
                        Cadastros
                        <span class="caret">‚ñæ</span>
                    </button>
                    <div class="submenu" id="cadastros-submenu">
                        <a class="submenu__item" href="/home/cadastros">Todos</a>
                        <a class="submenu__item" href="/home/cadastros/ativos">Ativos</a>
                        <a class="submenu__item" href="/home/cadastros/arquivados">Arquivados</a>
                        <a class="submenu__item" href="/home/cadastros/familiares">Familiares</a>
                    </div>
                </div>
                <a class="menu__item" href="/agendamentos">Agendamentos</a>
                <a class="menu__item" href="/home/atendimentos">Atendimentos</a>
                <a class="menu__item" href="/atividades/minhasatividades">Atividades</a>
            </nav>
        </aside>

        <div class="main">
            <header class="topbar">
                <div class="search">
                    <input type="text" placeholder="buscar..." />
                    <span class="search__icon">üîç</span>
                </div>
                <div class="user-menu" id="userMenu">
                    <div class="avatar" id="userMenuToggle">üë§</div>
                    <div class="user-menu__dropdown" id="userMenuDropdown">
                        <div class="user-menu__title">Usu√°rio</div>
                        <a href="/usuario/perfil/{{ request.user.username }}">Meu Perfil</a>
                        <a href="/atividades/minhasatividades">Minhas Atividades</a>
                        <a href="/sair">Sair</a>
                        {% if request.user.is_staff %}
                        <div class="user-menu__title">Admin</div>
                        <a href="/administrar/usuarios">Gerenciar Usu√°rios</a>
                        <a href="/administrar/adicionarUsuario">Adicionar Usu√°rio</a>
                        {% endif %}
                    </div>
                </div>
            </header>

            <section class="content">
                <h1>Editar Cadastro - {{ cadastro.nome }}</h1>

                <form method="post" enctype="multipart/form-data" class="form">
                    {% csrf_token %}
                    
                    {% if form.errors %}
                    <div class="form-errors">
                        <strong>Verifique os campos abaixo:</strong>
                        {{ form.non_field_errors }}
                    </div>
                    {% endif %}

                    <!-- Foto Section -->
                    <div class="form-section">
                        <div class="edit-form-container">
                            <div class="foto-section">
                                <h3>Foto</h3>
                                <div class="foto-preview" id="fotoPreview">
                                    {% if cadastro.foto %}
                                        <img src="{{ cadastro.foto.url }}" alt="Foto do cadastro">
                                    {% else %}
                                        <span>Nenhuma foto</span>
                                    {% endif %}
                                </div>
                                <button type="button" class="foto-upload-btn" id="fotoUploadBtn">
                                    Iniciar Webcam
                                </button>
                                <input type="file" id="fotoUploadInput" name="foto" class="foto-upload-input" accept="image/png,image/jpeg">
                                {% if form.foto.errors %}<div class="field-error">{{ form.foto.errors.0 }}</div>{% endif %}
                            </div>

                            <div class="identificacao-section">
                                <h3>Identifica√ß√£o</h3>
                                <div class="form-grid">
                                    <div class="form-group form-full-width">
                                        <label for="{{ form.nome.id_for_label }}">Nome</label>
                                        {{ form.nome }}
                                        {% if form.nome.errors %}<div class="field-error">{{ form.nome.errors.0 }}</div>{% endif %}
                                    </div>

                                    <div class="form-group">
                                        <label for="{{ form.data_cadastro.id_for_label }}">Data de Cadastro</label>
                                        {{ form.data_cadastro }}
                                        {% if form.data_cadastro.errors %}<div class="field-error">{{ form.data_cadastro.errors.0 }}</div>{% endif %}
                                    </div>

                                    <div class="form-group">
                                        <label for="{{ form.data_nascimento.id_for_label }}">Data de Nascimento</label>
                                        {{ form.data_nascimento }}
                                        {% if form.data_nascimento.errors %}<div class="field-error">{{ form.data_nascimento.errors.0 }}</div>{% endif %}
                                    </div>

                                    <div class="form-group">
                                        <label for="{{ form.naturalidade.id_for_label }}">Naturalidade</label>
                                        {{ form.naturalidade }}
                                        {% if form.naturalidade.errors %}<div class="field-error">{{ form.naturalidade.errors.0 }}</div>{% endif %}
                                    </div>

                                    <div class="form-group">
                                        <label for="{{ form.sexo_biologico.id_for_label }}">Sexo Biol√≥gico</label>
                                        {{ form.sexo_biologico }}
                                        {% if form.sexo_biologico.errors %}<div class="field-error">{{ form.sexo_biologico.errors.0 }}</div>{% endif %}
                                    </div>

                                    <div class="form-group">
                                        <label for="{{ form.identidade_genero.id_for_label }}">Identidade de G√™nero</label>
                                        {{ form.identidade_genero }}
                                        {% if form.identidade_genero.errors %}<div class="field-error">{{ form.identidade_genero.errors.0 }}</div>{% endif %}
                                    </div>

                                    <div class="form-group">
                                        <label for="{{ form.identidade_sexual.id_for_label }}">Identidade Sexual</label>
                                        {{ form.identidade_sexual }}
                                        {% if form.identidade_sexual.errors %}<div class="field-error">{{ form.identidade_sexual.errors.0 }}</div>{% endif %}
                                    </div>

                                    <div class="form-group">
                                        <label for="{{ form.estado_civil.id_for_label }}">Estado Civil</label>
                                        {{ form.estado_civil }}
                                        {% if form.estado_civil.errors %}<div class="field-error">{{ form.estado_civil.errors.0 }}</div>{% endif %}
                                    </div>

                                    <div class="form-group">
                                        <label for="{{ form.identidade_etnico_racial.id_for_label }}">Identidade √âtnico-Racial</label>
                                        {{ form.identidade_etnico_racial }}
                                        {% if form.identidade_etnico_racial.errors %}<div class="field-error">{{ form.identidade_etnico_racial.errors.0 }}</div>{% endif %}
                                    </div>

                                    <div class="form-group">
                                        <label for="{{ form.religiao.id_for_label }}">Religi√£o</label>
                                        {{ form.religiao }}
                                        {% if form.religiao.errors %}<div class="field-error">{{ form.religiao.errors.0 }}</div>{% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Remaining fields in a simple grid -->
                    <div class="form-section">
                        <h3 style="margin: 0 0 16px; font-size: 14px; font-weight: 600;">Informa√ß√µes Adicionais</h3>
                        <div class="form-grid">
                            {% for field in form %}
                                {% if field.name not in 'nome,data_cadastro,data_nascimento,naturalidade,sexo_biologico,identidade_genero,identidade_sexual,estado_civil,identidade_etnico_racial,religiao,foto,id,status' %}
                                    <div class="form-group {% if field.field.widget.input_type == 'textarea' %}form-full-width{% endif %}">
                                        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                                        {{ field }}
                                        {% if field.errors %}<div class="field-error">{{ field.errors.0 }}</div>{% endif %}
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Status field -->
                    <div class="form-section">
                        <h3 style="margin: 0 0 16px; font-size: 14px; font-weight: 600;">Status</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="{{ form.status.id_for_label }}">Status do Cadastro</label>
                                {{ form.status }}
                                {% if form.status.errors %}<div class="field-error">{{ form.status.errors.0 }}</div>{% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="primary-button">Salvar</button>
                        <a class="ghost-button" href="/cadastro">Cancelar</a>
                    </div>
                </form>
            </section>
        </div>
    </div>

    <script>
        const novoButton = document.getElementById('novoButton');
        const novoMenu = document.getElementById('novoMenu');
        const toggleButtons = document.querySelectorAll('.menu__item--toggle');
        const userMenuToggle = document.getElementById('userMenuToggle');
        const userMenuDropdown = document.getElementById('userMenuDropdown');
        const fotoUploadBtn = document.getElementById('fotoUploadBtn');
        const fotoUploadInput = document.getElementById('fotoUploadInput');
        const fotoPreview = document.getElementById('fotoPreview');

        if (novoButton) {
            novoButton.addEventListener('click', () => {
                novoMenu.classList.toggle('is-open');
            });
        }

        toggleButtons.forEach((button) => {
            button.addEventListener('click', () => {
                const target = document.getElementById(button.dataset.target);
                if (target) target.classList.toggle('is-open');
            });
        });

        if (userMenuToggle) {
            userMenuToggle.addEventListener('click', () => {
                userMenuDropdown.classList.toggle('is-open');
            });
        }

        const onlyDigits = (value) => value.replace(/\D/g, '');
        const formatCpf = (value) => {
            let v = onlyDigits(value).slice(0, 11);
            v = v.replace(/(\d{3})(\d)/, '$1.$2');
            v = v.replace(/(\d{3})(\d)/, '$1.$2');
            v = v.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
            return v;
        };
        const formatRg = (value) => {
            let v = onlyDigits(value).slice(0, 9);
            v = v.replace(/(\d{2})(\d)/, '$1.$2');
            v = v.replace(/(\d{3})(\d)/, '$1.$2');
            v = v.replace(/(\d{3})(\d{1})$/, '$1-$2');
            return v;
        };
        const formatTitulo = (value) => {
            let v = onlyDigits(value).slice(0, 12);
            v = v.replace(/(\d{4})(\d)/, '$1 $2');
            v = v.replace(/(\d{4})(\d)/, '$1 $2');
            v = v.replace(/(\d{4})(\d{1,4})$/, '$1 $2');
            return v.trim();
        };

        const applyMask = (id, formatter) => {
            const el = document.getElementById(id);
            if (!el) return;
            const handler = () => {
                el.value = formatter(el.value);
            };
            el.addEventListener('input', handler);
            handler();
        };

        applyMask('id_cpf_numero', formatCpf);
        applyMask('id_rg_numero', formatRg);
        applyMask('id_titulo_eleitor_numero', formatTitulo);

        // Foto upload functionality
        if (fotoUploadBtn) {
            fotoUploadBtn.addEventListener('click', (e) => {
                e.preventDefault();
                fotoUploadInput.click();
            });
        }

        if (fotoUploadInput) {
            fotoUploadInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const validTypes = ['image/png', 'image/jpeg'];
                    if (!validTypes.includes(file.type)) {
                        alert('Por favor, selecione apenas arquivos PNG ou JPEG');
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = (event) => {
                        fotoPreview.innerHTML = `<img src="${event.target.result}" alt="Preview da foto">`;
                    };
                    reader.readAsDataURL(file);
                }
            });
        }
    </script>
    <script src="{% static 'core/main_search.js' %}"></script>
</body>
</html>
